import axios from "axios";
import fs from "fs";
import FormData from "form-data";

const API_KEY = process.env.VIRUSTOTAL_API_KEY;
const BASE_URL = "https://www.virustotal.com/api/v3";

/*
========================================
SECUREVAULT AI MALWARE SCANNER
========================================
Returns:
{
  safe: true/false,
  maliciousCount: number,
  suspiciousCount: number,
  scanId: string,
  engines: number
}
========================================
*/

export async function scanFileForMalware(filePath) {

  try {

    if (!API_KEY) {
      throw new Error("VirusTotal API key missing");
    }

    if (!fs.existsSync(filePath)) {
      throw new Error("File not found for scanning");
    }

    /*
    ========================
    STEP 1: Upload file
    ========================
    */

    const formData = new FormData();
    formData.append("file", fs.createReadStream(filePath));

    const uploadResponse = await axios.post(
      `${BASE_URL}/files`,
      formData,
      {
        headers: {
          "x-apikey": API_KEY,
          ...formData.getHeaders(),
        },
        maxContentLength: Infinity,
        maxBodyLength: Infinity,
      }
    );

    const analysisId = uploadResponse.data?.data?.id;

    if (!analysisId) {
      throw new Error("Failed to get analysis ID");
    }

    /*
    ========================
    STEP 2: Wait for scan completion
    ========================
    */

    let analysisResult = null;
    let status = "queued";

    const MAX_WAIT_TIME = 60000; // 60 seconds
    const POLL_INTERVAL = 4000;  // 4 seconds

    const startTime = Date.now();

    while (status !== "completed") {

      // timeout protection
      if (Date.now() - startTime > MAX_WAIT_TIME) {

        console.log("Scan timeout - treating as safe");

        return {
          safe: true,
          maliciousCount: 0,
          suspiciousCount: 0,
          scanId: analysisId,
          engines: 0
        };
      }

      await new Promise(resolve =>
        setTimeout(resolve, POLL_INTERVAL)
      );

      const resultResponse = await axios.get(
        `${BASE_URL}/analyses/${analysisId}`,
        {
          headers: {
            "x-apikey": API_KEY
          }
        }
      );

      analysisResult = resultResponse.data?.data?.attributes;

      if (!analysisResult) continue;

      status = analysisResult.status;

      console.log("Scan status:", status);

      if (status === "completed") break;
    }

    /*
    ========================
    STEP 3: Extract stats
    ========================
    */

    const stats = analysisResult.stats || {};

    const maliciousCount = stats.malicious || 0;
    const suspiciousCount = stats.suspicious || 0;

    const engines =
      maliciousCount +
      suspiciousCount +
      (stats.harmless || 0) +
      (stats.undetected || 0);

    const safe =
      maliciousCount === 0 &&
      suspiciousCount === 0;

    /*
    ========================
    STEP 4: Return result
    ========================
    */

    return {
      safe,
      maliciousCount,
      suspiciousCount,
      scanId: analysisId,
      engines
    };

  }
  catch (error) {

  if (error.response?.status === 413) {

    console.log("File too large for VirusTotal scan");

    return {
      safe: true,
      skipped: true,
      reason: "File too large for scan"
    };

  }

  console.error("Malware scan error:", error.message);

  return {
    safe: false,
    error: true
  };
}

}
