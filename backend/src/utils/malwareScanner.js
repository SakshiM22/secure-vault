import axios from "axios";
import fs from "fs";
import FormData from "form-data";

const API_KEY = process.env.VIRUSTOTAL_API_KEY;
const BASE_URL = "https://www.virustotal.com/api/v3";

/*
========================================
AI MALWARE SCANNER FOR SECUREVAULT
========================================
Returns:
{
  safe: true/false,
  maliciousCount: number,
  suspiciousCount: number,
  scanId: string
}
========================================
*/

export async function scanFileForMalware(filePath) {

  try {

    if (!API_KEY) {
      throw new Error("VirusTotal API key missing");
    }

    if (!fs.existsSync(filePath)) {
      throw new Error("File not found for scanning");
    }

    const formData = new FormData();
    formData.append("file", fs.createReadStream(filePath));

    /*
    ========================
    STEP 1: Upload file
    ========================
    */

    const uploadResponse = await axios.post(
      `${BASE_URL}/files`,
      formData,
      {
        headers: {
          "x-apikey": API_KEY,
          ...formData.getHeaders(),
        },
        maxContentLength: Infinity,
        maxBodyLength: Infinity,
      }
    );

    const analysisId = uploadResponse.data.data.id;

    if (!analysisId) {
      throw new Error("Failed to get analysis ID");
    }

    /*
    ========================
    STEP 2: Poll scan result
    ========================
    */

    let analysisResult = null;
    let attempts = 0;
    const MAX_ATTEMPTS = 10;

    while (attempts < MAX_ATTEMPTS) {

      await new Promise(resolve => setTimeout(resolve, 2000));

      const resultResponse = await axios.get(
        `${BASE_URL}/analyses/${analysisId}`,
        {
          headers: {
            "x-apikey": API_KEY,
          },
        }
      );

      analysisResult = resultResponse.data.data.attributes;

      if (analysisResult.status === "completed") {
        break;
      }

      attempts++;
    }

    if (!analysisResult) {
      throw new Error("Scan result unavailable");
    }

    /*
    ========================
    STEP 3: Extract results
    ========================
    */

    const stats = analysisResult.stats;

    const maliciousCount = stats.malicious || 0;
    const suspiciousCount = stats.suspicious || 0;

    const safe = maliciousCount === 0 && suspiciousCount === 0;

    return {
      safe,
      maliciousCount,
      suspiciousCount,
      scanId: analysisId
    };

  } catch (error) {

    console.error("Malware scan error:", error.message);

    /*
    SECURITY POLICY:
    If scan fails â†’ treat as unsafe
    */

    return {
      safe: false,
      maliciousCount: 0,
      suspiciousCount: 0,
      error: true,
      message: error.message
    };
  }
}
